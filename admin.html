<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¡°êµ ê´€ë¦¬</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; background:#f7f7f8; margin:0; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:16px; margin-bottom:14px; }
    h1 { font-size:20px; margin:0 0 10px; }
    h2 { font-size:16px; margin:0 0 10px; }
    label { display:block; margin:10px 0 6px; font-size:14px; color:#222; }
    select, input, button { width:100%; height:44px; border-radius:12px; border:1px solid #d9d9d9; padding:10px 12px; font-size:16px; }
    button { border:none; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#444; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid { display:grid; grid-template-columns: repeat(10, 1fr); gap:8px; }
    .cell label { font-size:12px; color:#666; margin:0 0 4px; }
    .cell input { text-align:center; height:40px; font-weight:600; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding:10px; text-align:left; font-size:14px; }
    th { color:#666; font-weight:700; }
    .msg { margin-top:10px; padding:10px; border-radius:12px; display:none; white-space: pre-line; }
    .msg.ok { display:block; background:#eefbf1; border:1px solid #bfe8c7; color:#145a22; }
    .msg.err { display:block; background:#fff2f2; border:1px solid #f1b6b6; color:#7a1010; }

    /* ì‚­ì œ ë²„íŠ¼ë§Œ ì¡°ê¸ˆ ì‘ê²Œ */
    .delbtn {
      height: 34px;
      padding: 0 10px;
      border-radius: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ì¡°êµ ê´€ë¦¬ í˜ì´ì§€</h1>

      <div class="row">
        <div>
          <label>ìˆ˜ì—… ì„ íƒ</label>
          <select id="group">
            <option value="">ì„ íƒ</option>
            <option value="ê³ 1A">ê³ 1A</option>
            <option value="ê³ 1B">ê³ 1B</option>
            <option value="ê³ 2A">ê³ 2A</option>
            <option value="ê³ 2B">ê³ 2B</option>
            <option value="ê³ 3ë¯¸ì ">ê³ 3 ë¯¸ì </option>
            <option value="ê³ 3í™•í†µ">ê³ 3 í™•í†µ</option>
          </select>
        </div>
        <div>
          <label>ë¬¸í•­ ìˆ˜</label>
          <input id="count" placeholder="ì˜ˆ: 17" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <button id="loadBtn" class="secondary">ì •ë‹µ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>

      <div id="answerArea" style="margin-top:12px; display:none;">
        <h2>ì •ë‹µ ì…ë ¥</h2>
        <div id="answerGrid" class="grid"></div>
        <div style="margin-top:10px;">
          <button id="saveBtn">ì •ë‹µ ì €ì¥</button>
        </div>
      </div>

      <div id="msg" class="msg"></div>
    </div>

    <div class="card">
      <h2>ì œì¶œ ê²°ê³¼</h2>
      <div style="display:flex; gap:10px;">
        <button id="refreshBtn" class="secondary" style="flex:1;">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:180px;">ì‹œê°„</th>
              <th style="width:120px;">ì´ë¦„</th>
              <th>ì˜¤ë‹µë²ˆí˜¸</th>
              <th style="width:90px;">ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" style="color:#666;">ìˆ˜ì—… ì„ íƒ í›„ ìƒˆë¡œê³ ì¹¨ì„ ëˆ„ë¥´ì„¸ìš”.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  // â­ ì›¹ ì•± URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwu9vh2eeZ7IEel7RURO3c5fVEDWPHeMlwCKbwx7Qtgv6NK8CbvbZP9a2hmBFE-LApZ/exec";

  const groupEl = document.getElementById("group");
  const countEl = document.getElementById("count");
  const loadBtn = document.getElementById("loadBtn");
  const saveBtn = document.getElementById("saveBtn");
  const answerArea = document.getElementById("answerArea");
  const answerGrid = document.getElementById("answerGrid");
  const msgEl = document.getElementById("msg");

  const refreshBtn = document.getElementById("refreshBtn");
  const tbody = document.getElementById("tbody");

  /* ================= ë©”ì‹œì§€ (ìë™ ìˆ¨ê¹€) ================= */
  let msgTimer = null;
  function showMsg(type, text, autoHideMs = 2500) {
    msgEl.className = "msg " + type;
    msgEl.textContent = text;
    msgEl.style.display = "block";

    if (msgTimer) clearTimeout(msgTimer);
    if (autoHideMs > 0) {
      msgTimer = setTimeout(() => {
        msgEl.style.display = "none";
        msgEl.textContent = "";
        msgEl.className = "msg";
      }, autoHideMs);
    }
  }

  /* ================= ì„œë²„ í†µì‹  ================= */
  async function post(data) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(data)
    });

    const text = await res.text();
    try {
      return JSON.parse(text);
    } catch {
      return { status: "error", message: "ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨", raw: text };
    }
  }

  /* ================= ì •ë‹µ ì…ë ¥ UI ================= */
  function renderAnswerInputs(count, values = []) {
    answerGrid.innerHTML = "";
    for (let i = 1; i <= count; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";

      const label = document.createElement("label");
      label.textContent = i + "ë²ˆ";

      const input = document.createElement("input");
      input.type = "text";
      input.value = values[i - 1] ?? "";

      cell.appendChild(label);
      cell.appendChild(input);
      answerGrid.appendChild(cell);
    }
    answerArea.style.display = "block";
  }

  /* ================= ìë™ ì •ë‹µ ë¶ˆëŸ¬ì˜¤ê¸° ================= */
  async function loadAnswerByGroup(group) {
    if (!group) {
      countEl.value = "";
      answerArea.style.display = "none";
      tbody.innerHTML = `<tr><td colspan="4" style="color:#666;">ìˆ˜ì—… ì„ íƒ í›„ ìƒˆë¡œê³ ì¹¨ì„ ëˆ„ë¥´ì„¸ìš”.</td></tr>`;
      return;
    }

    const out = await post({ type: "getAnswerConfig", group });
    if (out.status !== "ok") {
      showMsg("err", out.message || "ì •ë‹µ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      return;
    }

    countEl.value = out.count || "";
    if (out.count) {
      renderAnswerInputs(out.count, out.answers || []);
      showMsg("ok", "ì •ë‹µ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
    } else {
      answerArea.style.display = "none";
      showMsg("ok", "ì €ì¥ëœ ì •ë‹µì´ ì—†ìŠµë‹ˆë‹¤. ë¬¸í•­ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    }

    // ì œì¶œ ê²°ê³¼ë„ ìë™ ìƒˆë¡œê³ ì¹¨
    refreshBtn.click();
  }

  /* ================= ì´ë²¤íŠ¸ ================= */

  // ğŸ”¥ ë¶„ë°˜ ì„ íƒ ì‹œ ìë™ ë¡œë”©
  groupEl.addEventListener("change", () => {
    loadAnswerByGroup(groupEl.value);
  });

  // (ë²„íŠ¼ ëˆŒëŸ¬ë„ ë™ì‘ì€ ë™ì¼)
  loadBtn.addEventListener("click", () => {
    loadAnswerByGroup(groupEl.value);
  });

  countEl.addEventListener("input", () => {
    const count = Number(countEl.value || 0);
    if (count > 0) renderAnswerInputs(count);
    else answerArea.style.display = "none";
  });

  saveBtn.addEventListener("click", async () => {
    const group = groupEl.value;
    const count = Number(countEl.value || 0);

    if (!group) return showMsg("err", "ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!count) return showMsg("err", "ë¬¸í•­ ìˆ˜ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const answers = Array.from(answerGrid.querySelectorAll("input")).map(i => i.value);
    const out = await post({ type: "saveAnswerConfig", group, count, answers });

    if (out.status === "ok") showMsg("ok", "ì •ë‹µ ì €ì¥ ì™„ë£Œ!");
    else showMsg("err", out.message || "ì •ë‹µ ì €ì¥ ì‹¤íŒ¨");
  });

  // ì‚­ì œ (ì´ë²¤íŠ¸ ìœ„ì„)
  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-del");
    if (!btn) return;

    const id = btn.dataset.id;
    if (!id) return showMsg("err", "idê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");

    if (!confirm("ì´ ì œì¶œ ê²°ê³¼ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

    const out = await post({ type: "deleteSubmission", id });
    if (out.status === "ok") {
      showMsg("ok", "ì‚­ì œ ì™„ë£Œ");
      refreshBtn.click();
    } else {
      showMsg("err", out.message || "ì‚­ì œ ì‹¤íŒ¨");
    }
  });

  refreshBtn.addEventListener("click", async () => {
    const group = groupEl.value;
    if (!group) return;

    const out = await post({ type: "getSubmissions", group });
    if (out.status !== "ok") {
      showMsg("err", out.message || "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      return;
    }

    const list = out.submissions || [];
    if (!list.length) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:#666;">ì œì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    tbody.innerHTML = list.map(x => `
      <tr>
        <td>${new Date(x.time).toLocaleString()}</td>
        <td>${escapeHtml(x.name)}</td>
        <td>${escapeHtml((x.wrong || "").replace(/,/g, ", "))}</td>
        <td>
          <button class="secondary delbtn js-del" data-id="${escapeAttr(x.id)}">ì‚­ì œ</button>
        </td>
      </tr>
    `).join("");
  });

  /* ================= util ================= */
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function escapeAttr(s) {
    return String(s).replace(/&/g, "&amp;").replace(/"/g, "&quot;");
  }
</script>

</body>
</html>
